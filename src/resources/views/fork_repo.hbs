<link rel="stylesheet" href="css/fork_repo.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<header>
    <div class="searchBox">
        <img src="img/search.svg" alt="">
        <input type="text" placeholder="Enter github repository url" value="{{repository.html_url}}">
    </div>
    <button class="submitButton">SUBMIT</button>
</header>
<div class="container">
    <div class="title">
        <div class="userAccount">
            <div class="userAvatar">
                <img class="userAvatar" src="{{repository.owner.avatar_url}}" alt="">
            </div>
            <p class="userName">{{repository.owner.login}}</p>
        </div>
        <div class="repositoryInfo">
            <div class="githubLogo">
                <p>GitHub</p>
                <img src="img/githublogo.png" alt="">
            </div>
            <div class="repoFullname">
                <p>{{repository.full_name}}</p>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="loading">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="forksContainer">
        </div>

    </div>
</div>
<script>   
    loadAheadCommit();

    function loadAheadCommit() {
        var request = new XMLHttpRequest();
        var secondRepository = "{{repository.url}}";
        var firstRepository = "https://api.github.com/repos/{{rootRepositoryFullName}}";
        request.open('GET', `api/compare_repository?firstRepository=${firstRepository}&secondRepository=${secondRepository}`, true);
        request.onload = function () {
            if (this.status >= 200 && this.status < 400) {
                let contentContainer = document.querySelector('.content');
                contentContainer.removeChild(document.querySelector('.content .loading'));
                parseCommit(JSON.parse(this.response));
            }
        }
        request.send();
    }

    function parseCommit(data) {
        console.log(data);
        var forksContainer = document.querySelector('.forksContainer');
        for (let branch of data) {
            let branchItem = document.createElement('div');
            branchItem.classList.add('branch');
            branchItem.innerHTML = 
                `<div class="branchTitle">
                    <p class="branchName">${branch.branch_name}</p>
                    <p class="numberOfCommits">${branch.aheadCommits.length}</p>
                </div>
                <div class="aheadCommits"></div>`;
            forksContainer.appendChild(branchItem);
            branchItem.querySelector(".branchTitle").addEventListener('click', () => {
                let aheadCommitsContainer = branchItem.querySelector('.aheadCommits');
                aheadCommitsContainer.classList.toggle('show');
            })

            let aheadCommitsContainer = branchItem.querySelector('.aheadCommits');
            for (let item of branch.aheadCommits) {
                let date = new Date(Date.parse(item.commit.author.date));
                let dateString = date.toLocaleDateString('de-De',
                    {
                        year: "numeric",
                        month: "long",
                        day: "numeric"
                    }
                );

                let commitItem = document.createElement('div');
                commitItem.classList.add('forkItem');
                commitItem.innerHTML =
                    `<div class="textArea">
                    <p class="message">${item.commit.message}</p>
                    <p class="committer">${item.author.login}</p><span> committed on </span><p class="commitDate">${dateString}</p>
                </div>
                <div class="goToCommitButton">View commit</div>`;
                commitItem.querySelector('.goToCommitButton').addEventListener('click', () => {
                    window.open(item.html_url, '_blank').focus();
                });
                aheadCommitsContainer.appendChild(commitItem);
            }
        }
    }
</script>